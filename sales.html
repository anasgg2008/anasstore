<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</title>
  <style>
    body {
      background-color: #111;
      color: white;
      font-family: sans-serif;
      padding: 20px;
      direction: rtl;
    }
    .top-bar {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
    }
    h1 {
      margin: 0;
      font-size: 28px;
      text-align: center;
      flex-grow: 1;
    }
    #menuBtn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: none;
      border: none;
      font-size: 28px;
      color: white;
      cursor: pointer;
      z-index: 1000;
      padding: 0;
      user-select: none;
      outline: none;
    }
    #dropdownMenu {
      display: none;
      position: fixed;
      top: 60px;
      left: 20px;
      background-color: #222;
      border-radius: 10px;
      width: 180px;
      z-index: 999;
      user-select: none;
      box-shadow: 0 0 10px #000;
    }
    #dropdownMenu a {
      color: white;
      padding: 12px 15px;
      display: block;
      text-decoration: none;
      border-bottom: 1px solid #444;
    }
    #dropdownMenu a:last-child {
      border-bottom: none;
    }
    #dropdownMenu a:hover {
      background-color: #444;
    }
    .day {
      border: 1px solid #444;
      border-radius: 10px;
      margin: 20px 0;
      padding: 15px;
      background-color: #222;
    }
    .day h3 {
      margin: 0 0 10px 0;
      font-size: 22px;
    }
    .summary {
      margin-bottom: 10px;
      color: #aaa;
      font-size: 16px;
    }
    .product-box {
      background-color: #333;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      position: relative;
    }
    .product-box:nth-child(odd) {
      background-color: #551111;
    }
    .product-box:nth-child(even) {
      background-color: #113355;
    }
    .product-box p {
      margin: 4px 0;
    }
    .btn {
      background-color: crimson;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px 5px 0 0;
      transition: background-color 0.3s;
    }
    .btn:hover {
      background-color: #b30000;
    }
    .btn-edit {
      background-color: #007bff;
    }
    .btn-edit:hover {
      background-color: #0056b3;
    }
    .actions {
      margin-top: 8px;
    }
    #exportAllPDFBtn {
      background-color: #0066cc;
      border: none;
      color: white;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      box-shadow: 0 0 8px #005bb5;
      margin: 15px auto 30px auto;
      display: block;
      transition: background-color 0.3s;
    }
    #exportAllPDFBtn:hover {
      background-color: #004d99;
    }
    /* Scrollbar for pre */
    pre {
      background-color: #333;
      padding: 10px;
      border-radius: 10px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
      margin-bottom: 10px;
    }
    /* Modal style */
    #editModal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.8);
      justify-content: center;
      align-items: center;
    }
    #editModal .modal-content {
      background-color: #222;
      border-radius: 15px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      color: white;
      position: relative;
    }
    #editModal label {
      display: block;
      margin-top: 12px;
      font-size: 16px;
    }
    #editModal input {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      border-radius: 8px;
      border: none;
      background-color: #333;
      color: white;
      font-size: 16px;
    }
    #editModal button {
      margin-top: 20px;
      padding: 10px 15px;
      font-size: 16px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    #editModal button.save-btn {
      background-color: #28a745;
      color: white;
    }
    #editModal button.save-btn:hover {
      background-color: #1e7e34;
    }
    #editModal button.cancel-btn {
      background-color: crimson;
      color: white;
      margin-left: 10px;
    }
    #editModal button.cancel-btn:hover {
      background-color: #b30000;
    }
    #editModal .close-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      user-select: none;
      color: white;
    }
  </style>
</head>
<body>

<button id="menuBtn">â‹®</button>
<div id="dropdownMenu">
  <a href="index.html">ğŸ  Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  <a href="products.html">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª</a>
  <a href="sales.html">ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</a>
</div>

<div class="top-bar">
  <h1>ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h1>
</div>

<div id="sales"></div>

<button id="exportAllPDFBtn">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙŠØ§Ù… PDF</button>

<!-- ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ -->
<div id="editModal">
  <div class="modal-content">
    <span class="close-btn" id="closeEditModal">&times;</span>
    <h2>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬</h2>
    <form id="editForm">
      <label for="editProductName">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</label>
      <input type="text" id="editProductName" required autocomplete="off" disabled />

      <label for="editQuantity">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
      <input type="number" id="editQuantity" min="1" required />

      <label for="editSellPrice">Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</label>
      <input type="number" id="editSellPrice" min="0" step="any" required />

      <label for="editProfit">Ø§Ù„Ø±Ø¨Ø­</label>
      <input type="number" id="editProfit" min="0" step="any" required />

      <button type="submit" class="save-btn">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      <button type="button" class="cancel-btn" id="cancelEditBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </form>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const { jsPDF } = window.jspdf;

  const menuBtn = document.getElementById("menuBtn");
  const dropdownMenu = document.getElementById("dropdownMenu");
  menuBtn.onclick = () => {
    dropdownMenu.style.display = dropdownMenu.style.display === "block" ? "none" : "block";
  };
  window.onclick = (e) => {
    if (!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
      dropdownMenu.style.display = "none";
    }
  };

  const salesDiv = document.getElementById("sales");
  const exportAllPDFBtn = document.getElementById("exportAllPDFBtn");

  let salesData = [];

  function loadSales() {
    salesData = [];
    salesDiv.innerHTML = "";
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith("sales-")) {
        const day = key.replace("sales-", "");
        const data = JSON.parse(localStorage.getItem(key));
        salesData.push({ day, data });
      }
    }
    salesData.sort((a, b) => b.day.localeCompare(a.day));
  }

  function renderSales() {
    salesDiv.innerHTML = "";
    salesData.forEach(({ day, data }) => {
      const container = document.createElement("div");
      container.className = "day";

      let totalProfit = 0;
      let totalSales = 0;

      const dayTitle = document.createElement("h3");
      dayTitle.textContent = `ğŸ“† ${day}`;

      const summary = document.createElement("div");
      summary.className = "summary";

      const productsContainer = document.createElement("div");

      data.forEach((item, index) => {
        const profit = parseFloat(item.profit ?? (item.sellPrice - (item.costPrice * item.quantity)));
        totalProfit += profit;
        totalSales += 1;

        const productBox = document.createElement("div");
        productBox.className = "product-box";
        productBox.style.backgroundColor = index % 2 === 0 ? "#551111" : "#113355";

        productBox.innerHTML = `
          <p>ğŸ“¦ Ø§Ù„Ù…Ù†ØªØ¬: ${item.product}</p>
          <p>ğŸ”¢ Ø§Ù„ÙƒÙ…ÙŠØ©: ${item.quantity}</p>
          <p>ğŸ’° Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${item.sellPrice} Ù„.Ø³</p>
          <p>ğŸ’µ Ø§Ù„Ø±Ø¨Ø­: ${profit.toFixed(0)} Ù„.Ø³</p>
          <p>ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${item.time}</p>
          <div class="actions">
            <button class="btn btn-edit" data-day="${day}" data-index="${index}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn btn-delete" data-day="${day}" data-index="${index}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </div>
        `;

        productsContainer.appendChild(productBox);
      });

      summary.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: ${totalSales} â€” Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙƒÙ„ÙŠ: ${totalProfit.toFixed(0)} Ù„.Ø³`;

      const deleteDayBtn = document.createElement("button");
      deleteDayBtn.textContent = "ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…";
      deleteDayBtn.className = "btn";
      deleteDayBtn.style.backgroundColor = "crimson";
      deleteDayBtn.onclick = () => deleteDay(day);

      const exportPDFBtn = document.createElement("button");
      exportPDFBtn.textContent = "â¬‡ï¸ ØªØµØ¯ÙŠØ± PDF Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…";
      exportPDFBtn.className = "btn";
      exportPDFBtn.style.backgroundColor = "#0066cc";
      exportPDFBtn.onclick = () => exportDayPDF(day, data);

      container.appendChild(deleteDayBtn);
      container.appendChild(dayTitle);
      container.appendChild(summary);
      container.appendChild(productsContainer);
      container.appendChild(exportPDFBtn);

      salesDiv.appendChild(container);
    });

    attachProductButtons();
  }

  function attachProductButtons() {
    const editButtons = document.querySelectorAll(".btn-edit");
    const deleteButtons = document.querySelectorAll(".btn-delete");

    editButtons.forEach(btn => {
      btn.onclick = () => openEditModal(btn.dataset.day, btn.dataset.index);
    });

    deleteButtons.forEach(btn => {
      btn.onclick = () => {
        const day = btn.dataset.day;
        const index = parseInt(btn.dataset.index, 10);
        if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ØŸ")) {
          const dayData = salesData.find(d => d.day === day);
          if (!dayData) return;
          dayData.data.splice(index, 1);
          if (dayData.data.length === 0) {
            localStorage.removeItem("sales-" + day);
            salesData = salesData.filter(d => d.day !== day);
          } else {
            localStorage.setItem("sales-" + day, JSON.stringify(dayData.data));
          }
          renderSales();
        }
      };
    });
  }

  function deleteDay(day) {
    if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù„ÙŠÙˆÙ… ${day}ØŸ`)) {
      localStorage.removeItem("sales-" + day);
      salesData = salesData.filter(d => d.day !== day);
      renderSales();
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ - Ù…ÙˆØ¯Ø§Ù„
  const editModal = document.getElementById("editModal");
  const closeEditModalBtn = document.getElementById("closeEditModal");
  const cancelEditBtn = document.getElementById("cancelEditBtn");
  const editForm = document.getElementById("editForm");
